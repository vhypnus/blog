



一致性协议分为以下几个部分

- leader 选举
- 日志复制 
- 成员变化
- 安全性

角色

- leader，负责处理客户端的请求（如果一个客户端与追随者进行通信，追随者会将信息发送给领导人）
- follower，只响应leader的或者candidate的请求
- candidate，新领导候选人，follower如果超时并未收到leader的心跳，就会变成候选人



角色状态变化 

- 追随者只响应其他服务器的请求。如果追随者没有收到任何消息，它会成为一个候选人并且开始一次选举。收到大多数服务器投票的候选人会成为新的领导人。
- 领导人在它们宕机之前会一直保持领导人的状态。

日志复制

- 所有人客户端请求都必须 包含一条需求被执行的命令
- leader将这条命令以日志的形式追加到日志里
- 向其它机器发起appendEntries rpc请求
- 如果因为超时等其它原因，leader会重试发送请求



日志是有序日志条目组成，日志条目的关键信息包含

- 任期号
- 执行的命令

leader判断日志是否可提交 

- 多数派

日志一致性约束

- 如果在不同日志中的两个条目有着相同的索引和任期号，则它们所存储的命令是相同的。
- 如果在不同日志中的两个条目有着相同的索引和任期号，则它们之间的所有条目都是完全一样的。

不一致时的处理办法 

- leader首先得确认和follower日志一致的位置 
- 删除follower在该位置之后的日志 
- 再将自己在该位置之后的日志发送给follower



### Q & A 



# 参考文档

- https://www.infoq.cn/article/raft-paper
- https://cloud.tencent.com/developer/article/1394643